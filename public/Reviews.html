<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reviews - Marketplace</title>
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <!-- Shared Topbar -->
    <div id="shared-topbar-root">
      <!-- Topbar will be rendered here -->
    </div>

    <div class="container">
      <div id="reviews-content">
        <!-- Reviews content will be rendered here -->
      </div>
    </div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Load hooks and components for topbar -->
    <script src="js/hooks/useAuth.js"></script>
    <script src="js/components/shared/topbar/UserInfo.js"></script>
    <script src="js/components/shared/topbar/Logout.js"></script>
    <script src="js/components/shared/topbar/topbar.js"></script>

    <!-- Load reviews components -->
    <script src="js/utils/DataUtils.js"></script>
    <script src="js/components/shared/components.js"></script>
    <script src="js/components/views/ReviewsView.js"></script>

    <!-- Load shared components -->
    <script src="js/components/shared/topbar/TopbarLoader.js"></script>
    <script src="js/components/shared/layout.js"></script>

    <script>
      // Initialize reviews page
      async function initializeReviews() {
        // Initialize shared topbar first
        const topbarResult = await window.SharedTopbar.initialize(
          "shared-topbar-root",
          {
            activeTab: "reviews",
          }
        );

        if (!topbarResult.success || !topbarResult.authenticated) {
          document.getElementById("reviews-content").innerHTML =
            '<div class="error">Please log in to view reviews. <a href="index.html">Go to Login</a></div>';
          return;
        }

        // Initialize reviews view
        const root = ReactDOM.createRoot(
          document.getElementById("reviews-content")
        );

        // Show loading state
        root.render(
          SharedLayout.render(
            React.createElement(ReviewsView, {
              data: null,
              loading: true,
              error: null,
            })
          )
        );

        try {
          // Get auth token for API calls
          const token =
            localStorage.getItem("marketplace_token") ||
            sessionStorage.getItem("marketplace_token");

          // Fetch ALL reviews data from API
          const response = await fetch("/api/reviews/all?limit=1000", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const result = await response.json();
            console.log("Reviews API response:", result);

            // Handle ApiResponse format
            let reviewsData;
            if (result.data && result.data.reviews) {
              reviewsData = result.data.reviews;
            } else if (result.data) {
              reviewsData = result.data;
            } else if (result.reviews) {
              reviewsData = result.reviews;
            } else {
              reviewsData = result;
            }

            // Render reviews view with data
            root.render(
              SharedLayout.render(
                React.createElement(ReviewsView, {
                  data: { reviews: reviewsData },
                  loading: false,
                  error: null,
                })
              )
            );
          } else {
            const errorText = await response.text();
            console.error("Reviews API error:", errorText);

            // Render error state
            root.render(
              SharedLayout.render(
                React.createElement(ReviewsView, {
                  data: null,
                  loading: false,
                  error: `Failed to load reviews: ${errorText}`,
                })
              )
            );
          }
        } catch (error) {
          console.error("Reviews loading error:", error);

          // Render error state
          root.render(
            SharedLayout.render(
              React.createElement(ReviewsView, {
                data: null,
                loading: false,
                error: `Error loading reviews: ${error.message}`,
              })
            )
          );
        }
      }

      document.addEventListener("DOMContentLoaded", initializeReviews);
    </script>
  </body>
</html>
